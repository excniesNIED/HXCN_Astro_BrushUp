---
const currentUrlPath = Astro.url.pathname.replace(/\/+$/, "");
const segments = currentUrlPath.split("/").filter(Boolean);

type Crumb = { label: string; href?: string };

const isNumberSegment = (seg: string | undefined) => seg && !isNaN(Number(seg));

const buildHref = (endIndex: number) =>
  `/${segments.slice(0, endIndex + 1).join("/")}/`;

const labelMap: Record<string, string> = {
  post: "分类",
  posts: "文章",
  tags: "标签",
  archives: "归档",
  search: "搜索",
  about: "关于",
};

let crumbs: Crumb[] = segments.map((segment, index) => ({
  label: labelMap[segment] ?? decodeURIComponent(segment),
  href: index + 1 === segments.length ? undefined : buildHref(index),
}));

// Home > Posts (page N)
if (segments[0] === "posts" && isNumberSegment(segments[1])) {
  const page = Number(segments[1] ?? 1);
  crumbs = [{ label: `文章（第 ${page} 页）` }];
}

// Home > Tags > tag (page N)
if (segments[0] === "tags" && isNumberSegment(segments[2])) {
  const tag = decodeURIComponent(segments[1] ?? "");
  const page = Number(segments[2] ?? 1);
  crumbs = [
    { label: "标签", href: "/tags/" },
    { label: `${tag}${page === 1 ? "" : `（第 ${page} 页）`}` },
  ];
}
---

<nav class="app-layout mt-8 mb-1" aria-label="breadcrumb">
  <ul
    class="font-light [&>li]:inline [&>li:not(:last-child)>a]:hover:opacity-100"
  >
    <li>
      <a href="/" class="opacity-80">Home</a>
      <span aria-hidden="true" class="opacity-80">&raquo;</span>
    </li>
    {
      crumbs.map((crumb, index) =>
        index + 1 === crumbs.length ? (
          <li>
            <span
              class:list={["capitalize opacity-75", { lowercase: index > 0 }]}
              aria-current="page"
            >
              {/* make the last part lowercase in Home > Tags > some-tag */}
              {crumb.label}
            </span>
          </li>
        ) : (
          <li>
            <a href={crumb.href} class="capitalize opacity-70">
              {crumb.label}
            </a>
            <span aria-hidden="true">&raquo;</span>
          </li>
        )
      )
    }
  </ul>
</nav>
